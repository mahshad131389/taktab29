<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Bottle Shooting Game</title>
  <link rel="stylesheet" href="styles.css">

  <!-- Error handling -->
  <script>
    window.addEventListener('error', function(event) {
      console.error('Global error:', event.message, event.filename, event.lineno);
    });
  </script>

  <!-- A-Frame AR -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>

  <style>
    /* وسط‌چین کردن و بزرگ کردن گیم - کاملاً ترنسپرنت */
    #game-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    #game-overlay.visible {
      display: flex;
    }
    #game-iframe {
      width: 80%;
      height: 80%;
      border: none;
      border-radius: 12px;
      background: transparent; /* پس‌زمینه حذف شد */
    }
  </style>
  
  
</head>
<body>
  <!-- AR Content -->
  <a-scene mindar-image="imageTargetSrc:cow2.mind;"
            color-space="sRGB"
            renderer="colorManagement: true, physicallyCorrectLights"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false"
            embedded>
    <!-- Camera with raycaster -->
    <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="far: 10000; objects: .clickable"></a-camera>

    <!-- Target anchor -->
    <a-entity mindar-image-target="targetIndex: 0">
      <a-entity id="bottle-container" class="clickable" position="0 0 0">
        <!-- Bottle body -->
        <a-cylinder id="bottle" class="clickable" height="0.5" radius="0.15" color="#8B4513" position="0 0 0" opacity="0.8"></a-cylinder>
        <!-- Bottle neck -->
        <a-cylinder height="0.2" radius="0.08" color="#8B4513" position="0 0.35 0" opacity="0.8"></a-cylinder>
        <!-- Bottle cap -->
        <a-cylinder height="0.05" radius="0.08" color="red" position="0 0.475 0"></a-cylinder>
      </a-entity>
    </a-entity>
  </a-scene>

  <!-- UI Container -->
  <div id="ui-container">
    <div id="score-container">Score: <span id="score">0</span></div>
    <button id="start-button">Start Game</button>
  </div>

  <!-- Fullscreen game overlay -->
  <div id="game-overlay">
    <button id="close-game">Close</button>
    <iframe id="game-iframe" src="assets/game/index.html" allow="autoplay; fullscreen; gamepad; xr-spatial-tracking; camera; microphone" allowtransparency="true"></iframe>
  </div>

  <!-- Error message -->
  <div id="error-message" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(255, 0, 0, 0.7); color: white; padding: 20px; border-radius: 10px; text-align: center; z-index: 10;">
    <h3>Error</h3>
    <p id="error-text"></p>
    <button id="reload-button" onclick="location.reload()">Reload</button>
  </div>

  <!-- Game script -->
  <script>
    // Game variables
    let score = 0;
    const scoreElement = document.getElementById('score');
    const startButton = document.getElementById('start-button');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');

    // Show error
    function showError(message) {
      errorText.textContent = message;
      errorMessage.style.display = 'block';
      console.error('Game error:', message);
    }

    // Update score
    function updateScore() {
      scoreElement.textContent = score;
    }

    // Start game
    startButton.addEventListener('click', function() {
      startButton.style.display = 'none';

      // Check camera access
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showError('Your browser does not support camera access. Please use a modern browser.');
      }

      // Open overlay
      const overlay = document.getElementById('game-overlay');
      if (overlay) overlay.classList.add('visible');
    });

    // Bottle click
    const bottle = document.getElementById('bottle');
    bottle.addEventListener('click', function() {
      score += 10;
      updateScore();

      // Flash animation
      bottle.setAttribute('animation', 'property: material.color; from: #8B4513; to: #ff0000; dur: 200; loop: 1');

      // Sound
      const hitSound = new Audio();
      hitSound.src = 'assets/sounds/hit.mp3';
      hitSound.play().catch(e => console.log('Sound not available'));
    });

    // Scene events
    document.addEventListener('DOMContentLoaded', function() {
      const sceneEl = document.querySelector('a-scene');
      const overlay = document.getElementById('game-overlay');
      const closeBtn = document.getElementById('close-game');
      const gameIframe = document.getElementById('game-iframe');
      const targetEl = document.querySelector('[mindar-image-target]');

      sceneEl.addEventListener('loaded', function() {
        console.log('AR scene loaded');
      });

      const onTargetFound = function() {
        console.log('Target found');
        if (overlay) overlay.classList.add('visible');
      };
      sceneEl.addEventListener('targetFound', onTargetFound);
      if (targetEl) targetEl.addEventListener('targetFound', onTargetFound);

      const onTargetLost = function() {
        console.log('Target lost');
      };
      sceneEl.addEventListener('targetLost', onTargetLost);
      if (targetEl) targetEl.addEventListener('targetLost', onTargetLost);

      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          if (overlay) overlay.classList.remove('visible');
          if (gameIframe) {
            const src = gameIframe.getAttribute('src');
            gameIframe.setAttribute('src', src);
          }
        });
      }
    });
  </script>
</body>
</html>
